name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "QEMU version to build, like 10.2.0-rc1"
        required: false
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build ${{ matrix.targets.name }}
    runs-on: ${{ matrix.targets.runner }}
    strategy:
      fail-fast: false
      matrix:
        targets:
          # Alpine (musl)
          - platform: linux/amd64
            image: amd64/alpine:latest
            name: linux-x86_64-musl
            runner: ubuntu-24.04
          - platform: linux/arm64
            image: arm64v8/alpine:latest
            name: linux-aarch64-musl
            runner: ubuntu-24.04-arm
          - platform: linux/arm/v7
            image: arm32v7/alpine:latest
            name: linux-armv7-musl
            runner: ubuntu-24.04-arm
          - platform: linux/ppc64le
            image: ppc64le/alpine:latest
            name: linux-ppc64le-musl
            runner: ubuntu-24.04
          - platform: linux/riscv64
            image: riscv64/alpine:edge
            name: linux-riscv64-musl
            runner: ubuntu-24.04
          - platform: linux/s390x
            image: s390x/alpine:latest
            name: linux-s390x-musl
            runner: ubuntu-24.04
          # Ubuntu (glibc)
          - platform: linux/amd64
            image: amd64/ubuntu:24.04
            name: linux-x86_64-gnu
            runner: ubuntu-24.04
          - platform: linux/arm64
            image: arm64v8/ubuntu:24.04
            name: linux-aarch64-gnu
            runner: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU
        if: matrix.targets.runner == 'ubuntu-24.04'
        uses: docker/setup-qemu-action@v3

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ matrix.targets.name }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.targets.name }}-

      - name: Build
        id: build
        run: |
          # Get version from tag (v10.2.0-rc1 -> 10.2.0-rc1) or input
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ inputs.version }}"
          fi

          docker run --rm \
            --platform ${{ matrix.targets.platform }} \
            --volume "${PWD}:/build" \
            --volume "${PWD}/.ccache:/root/.ccache" \
            --workdir /build \
            -e CCACHE_DIR=/root/.ccache \
            ${{ matrix.targets.image }} \
            /bin/sh -c "sh build.sh ${VERSION}"

          cp qemu-*/qemu-user-static.tgz qemu-user-static-${{ matrix.targets.name }}.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: qemu-user-static-${{ matrix.targets.name }}
          path: qemu-user-static-${{ matrix.targets.name }}.tgz

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          # Set release flags based on whether it's an rc version
          if [[ "${VERSION}" == *rc* ]]; then
            RELEASE_FLAGS="--prerelease --latest=false"
          else
            RELEASE_FLAGS="--latest=true"
          fi

          gh release view "${{ github.ref_name }}" --repo ${{ github.repository }} || \
            gh release create "${{ github.ref_name }}" --repo ${{ github.repository }} --title "${{ github.ref_name }}" --notes "Release ${{ github.ref_name }}" ${RELEASE_FLAGS} || true
          gh release upload "${{ github.ref_name }}" *.tgz --clobber --repo ${{ github.repository }}

  docker:
    name: Docker ${{ matrix.docker.name }}
    runs-on: ${{ matrix.docker.runner }}
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        docker:
          - name: linux-x86_64-musl
            artifact: linux-x86_64-musl
            platform: linux/amd64
            runner: ubuntu-24.04
          - name: linux-aarch64-musl
            artifact: linux-aarch64-musl
            platform: linux/arm64
            runner: ubuntu-24.04-arm
          - name: linux-armv7-musl
            artifact: linux-armv7-musl
            platform: linux/arm/v7
            runner: ubuntu-24.04-arm
          - name: linux-ppc64le-musl
            artifact: linux-ppc64le-musl
            platform: linux/ppc64le
            runner: ubuntu-24.04
          - name: linux-riscv64-musl
            artifact: linux-riscv64-musl
            platform: linux/riscv64
            runner: ubuntu-24.04
          - name: linux-s390x-musl
            artifact: linux-s390x-musl
            platform: linux/s390x
            runner: ubuntu-24.04
          - name: linux-x86_64-gnu
            artifact: linux-x86_64-gnu
            platform: linux/amd64
            runner: ubuntu-24.04
          - name: linux-aarch64-gnu
            artifact: linux-aarch64-gnu
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6

      - name: Get version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          if [[ "${VERSION}" == *rc* ]]; then
            echo "is_rc=true" >> $GITHUB_OUTPUT
          else
            echo "is_rc=false" >> $GITHUB_OUTPUT
          fi

      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: qemu-user-static-${{ matrix.docker.artifact }}
          path: artifacts

      - name: Prepare docker context
        run: |
          mkdir -p docker-context
          tar -xzf artifacts/qemu-user-static-${{ matrix.docker.artifact }}.tgz -C docker-context
          cp Dockerfile docker-context/

      - name: Set up QEMU
        if: matrix.docker.runner == 'ubuntu-24.04'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: docker-context
          push: true
          platforms: ${{ matrix.docker.platform }}
          provenance: false
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}-${{ matrix.docker.name }}
            ${{ steps.version.outputs.is_rc == 'false' && format('ghcr.io/{0}:{1}', github.repository, matrix.docker.name) || '' }}

  docker-manifest:
    name: Create Docker Manifest
    runs-on: ubuntu-24.04
    needs: docker
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      packages: write
    steps:
      - name: Get version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          if [[ "${VERSION}" == *rc* ]]; then
            echo "is_rc=true" >> $GITHUB_OUTPUT
          else
            echo "is_rc=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifests
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="ghcr.io/${{ github.repository }}"
          IS_RC="${{ steps.version.outputs.is_rc }}"

          # Use version-prefixed image tags (these are always created by docker job)
          MUSL_IMAGES="${REPO}:${VERSION}-linux-x86_64-musl ${REPO}:${VERSION}-linux-aarch64-musl ${REPO}:${VERSION}-linux-armv7-musl ${REPO}:${VERSION}-linux-ppc64le-musl ${REPO}:${VERSION}-linux-riscv64-musl ${REPO}:${VERSION}-linux-s390x-musl"
          GNU_IMAGES="${REPO}:${VERSION}-linux-x86_64-gnu ${REPO}:${VERSION}-linux-aarch64-gnu"

          # Create version-specific manifests (for both rc and non-rc)
          docker manifest create ${REPO}:${VERSION} ${MUSL_IMAGES}
          docker manifest push ${REPO}:${VERSION}

          docker manifest create ${REPO}:${VERSION}-musl ${MUSL_IMAGES}
          docker manifest push ${REPO}:${VERSION}-musl

          docker manifest create ${REPO}:${VERSION}-gnu ${GNU_IMAGES}
          docker manifest push ${REPO}:${VERSION}-gnu

          # Only create latest/musl/gnu and unversioned arch tags for non-rc versions
          if [[ "${IS_RC}" == "false" ]]; then
            MUSL_UNVERSIONED="${REPO}:linux-x86_64-musl ${REPO}:linux-aarch64-musl ${REPO}:linux-armv7-musl ${REPO}:linux-ppc64le-musl ${REPO}:linux-riscv64-musl ${REPO}:linux-s390x-musl"
            GNU_UNVERSIONED="${REPO}:linux-x86_64-gnu ${REPO}:linux-aarch64-gnu"

            for tag in latest musl; do
              docker manifest create ${REPO}:${tag} ${MUSL_UNVERSIONED}
              docker manifest push ${REPO}:${tag}
            done

            docker manifest create ${REPO}:gnu ${GNU_UNVERSIONED}
            docker manifest push ${REPO}:gnu
          fi
